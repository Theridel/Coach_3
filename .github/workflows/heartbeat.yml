# controlliamo l'ecosistema
name: Heartbeat - Test quotidiano

on:
  schedule:
    - cron: "8 8 * * *"   # ogni ora, all'8avo minuto (UTC)

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ecosystem_check:
    name: "Heartbeat & Vercel Inspector"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: 1. Setup Workspace
        run: |
          mkdir -p logs
          echo "Inizializzazione check ecosistema: $(date -u)"

      - name: 2. Heartbeat (Stato Sistema)
        run: |
          TS="$(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          echo "Heartbeat OK - $TS" > logs/ecosystem.log
          # Stampiamo anche a video per vederlo subito nei log di GitHub
          echo "Pulsazione registrata: $TS"

      - name: 3. Inspector (Vercel App)
        env:
          APP_URL: "https://coach-2-0-git-sviluppo-theridels-projects.vercel.app/"
        run: |
          # Eseguiamo il check di Vercel
          STATUS=$(curl -sS -o /dev/null -w "%{http_code}" -L \
                    --max-time 15 --connect-timeout 5 \
                    "$APP_URL" || echo "000")
          
          TS="$(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          
          # Scriviamo nello STESSO file del heartbeat usando >>
          echo "$TS - Vercel Status: $STATUS" >> logs/ecosystem.log
          echo "Status Vercel rilevato: $STATUS"

      - name: 4. Carica Report Unificato
        uses: actions/upload-artifact@v4
        with:
          # Un solo artifact con entrambi i risultati
          name: ecosystem-report-${{ github.run_number }}
          path: logs/ecosystem.log
          retention-days: 7
          
# --- TERZO JOB: INTERROGA SUPABASE ---
  keep-alive-supabase:
    runs-on: ubuntu-latest
    steps:
      - name: Simple Ping to Supabase
        env:
          SB_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          # Facciamo una richiesta anonima. 
          # Risponderà probabilmente con un 401 (Unauthorized), 
          # ma è sufficiente per "svegliare" l'infrastruttura.
          curl -i $SB_URL > supabase_ping.txt

      - name: Upload Simple Ping Artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-ping
          path: supabase_ping.txt
          retention-days: 7

# --- QUARTO JOB: HEARTBEAT HUGGING FACE SPACE ---
  keep-alive-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Ping HuggingFace Space
        env:
          HF_URL: "https://theridel-orchestratore.hf.space"
        run: |
          echo "➡️ Contatto lo Space HF: $HF_URL"
          CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HF_URL" || echo "000")
          TS="$(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          echo "$TS - HF Status: $CODE" > hf_ping.txt
          echo "Stato HF rilevato: $CODE"

      - name: Upload HF Ping Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hf-ping
          path: hf_ping.txt
          retention-days: 7
