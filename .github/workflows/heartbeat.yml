# controlliamo l'ecosistema
name: Heartbeat - Test quotidiano

on:
  schedule:
    - cron: "8 8 * * *"   # ogni ora, all'8avo minuto (UTC)

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ecosystem_check:
    name: "Heartbeat & Vercel Inspector"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: 1. Setup Workspace
        run: |
          mkdir -p logs
          echo "Inizializzazione check ecosistema: $(date -u)"

      - name: 2. Heartbeat (Stato Sistema)
        run: |
          TS="$(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          echo "Heartbeat OK - $TS" > logs/ecosystem.log
          # Stampiamo anche a video per vederlo subito nei log di GitHub
          echo "Pulsazione registrata: $TS"

      - name: 3. Inspector (Vercel App)
        env:
          APP_URL: "https://coach-2-0-git-sviluppo-theridels-projects.vercel.app/"
        run: |
          # Eseguiamo il check di Vercel
          STATUS=$(curl -sS -o /dev/null -w "%{http_code}" -L \
                    --max-time 15 --connect-timeout 5 \
                    "$APP_URL" || echo "000")
          
          TS="$(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          
          # Scriviamo nello STESSO file del heartbeat usando >>
          echo "$TS - Vercel Status: $STATUS" >> logs/ecosystem.log
          echo "Status Vercel rilevato: $STATUS"

      - name: 4. Carica Report Unificato
        uses: actions/upload-artifact@v4
        with:
          # Un solo artifact con entrambi i risultati
          name: ecosystem-report-${{ github.run_number }}
          path: logs/ecosystem.log
          retention-days: 7
          
# --- TERZO JOB: INTERROGA SUPABASE ---
  keep-alive-supabase:
    runs-on: ubuntu-latest
    steps:
      - name: Simple Ping to Supabase
        env:
          SB_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          # Facciamo una richiesta anonima. 
          # Risponderà probabilmente con un 401 (Unauthorized), 
          # ma è sufficiente per "svegliare" l'infrastruttura.
          curl -i $SB_URL > supabase_ping.txt

      - name: Upload Simple Ping Artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-ping
          path: supabase_ping.txt
          retention-days: 7

# --- QUARTO JOB: HEARTBEAT HUGGING FACE SPACE ---
  keep-alive-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Ping HuggingFace Space
        env:
          HF_URL: "https://theridel-orchestratore.hf.space"
        run: |
          echo "➡️ Contatto lo Space HF: $HF_URL"
          CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HF_URL" || echo "000")
          TS="$(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          echo "$TS - HF Status: $CODE" > hf_ping.txt
          echo "Stato HF rilevato: $CODE"

      - name: Upload HF Ping Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hf-ping
          path: hf_ping.txt
          retention-days: 7

          
# --- TEST GITHUB -> HF /ingest (A: senza firma -> 401, B: con firma -> 200) ---
  test-ingest-endpoint:
    name: "Test HF /ingest (401 no-sign, 200 signed)"
    runs-on: ubuntu-latest
    steps:
      - name: Prepare payload
        id: prep
        run: |
          TS="$(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          TEXT="probe from GitHub at $TS (no sanitize yet)"
          cat > payload.json <<JSON
          {
            "source": "github-test",
            "text": "${TEXT}",
            "meta": {
              "repo": "${{ github.repository }}",
              "run_id": "${{ github.run_id }}",
              "run_number": "${{ github.run_number }}",
              "sha": "${{ github.sha }}"
            }
          }
          JSON
          echo "Payload:"
          cat payload.json

      - name: Test A - POST without signature (should be 401)
        env:
          HF_INGEST_URL: ${{ secrets.HF_INGEST_URL }}
        run: |
          CODE=$(curl -s -o respA.json -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            --data-binary @payload.json \
            "$HF_INGEST_URL" || echo "000")
          echo "HTTP (no-sign): $CODE"
          echo "Response:"
          cat respA.json
          # Verifica: ci aspettiamo 401
          if [ "$CODE" -ne 401 ]; then
            echo "Atteso 401 senza firma, ottenuto $CODE" >&2
            exit 1
          fi

      - name: Compute HMAC-SHA256 signature
        id: sign
        run: |
          SIG_HEX=$(openssl dgst -sha256 -hmac '${{ secrets.HMAC_SECRET }}' payload.json | awk '{print $2}')
          echo "signature=sha256=${SIG_HEX}" >> $GITHUB_OUTPUT
          echo "Sig: sha256=${SIG_HEX}"

