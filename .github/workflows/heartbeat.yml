# Controlliamo l'ecosistema
name: Heartbeat - Test quotidiano

on:
  schedule:
    - cron: "8 */8 * * *"   # ogni 8 ore, all'8avo minuto (UTC)
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --- PRIMO JOB: HEARTBEAT, VERCEL E HUGGING FACE CHECK ---
  ecosystem_check:
    name: "Heartbeat & system inspector"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: 1. Setup Workspace
        run: |
          mkdir -p logs
          echo "Inizializzazione check ecosistema: $(date -u)"

      - name: 2. Heartbeat (Stato Sistema)
        run: |
          TS="$(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          echo "Heartbeat OK - $TS" > logs/ecosystem.log
          # Stampiamo anche a video per vederlo subito nei log di GitHub
          echo "Pulsazione registrata: $TS"

      - name: 3a. Inspector (Vercel App)
        env:
          APP_URL: "https://coach3-git-sviluppo-theridels-projects.vercel.app/"
        run: |
          # Eseguiamo il check di Vercel
          STATUS=$(curl -sS -o /dev/null -w "%{http_code}" -L \
                    --max-time 15 --connect-timeout 5 \
                    "$APP_URL" || echo "000")
          
          TS="$(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          
          # Scriviamo nello STESSO file del heartbeat usando >>
          echo "$TS - Vercel Status: $STATUS" >> logs/ecosystem.log
          echo "Status Vercel rilevato: $STATUS"

      - name: 3b. Heartbeat (Hugging Face)
        env:
          HF_URL: "https://theridel-orchestratore.hf.space"
        run: |
          # Eseguiamo il ping
          CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HF_URL" || echo "000")
          TS="$(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          
          # APPENDIAMO allo stesso file di Vercel
          echo "$TS - HF Status: $CODE" >> logs/ecosystem.log
          echo "Stato HF aggiunto al log: $CODE"
          
      - name: 4. Carica Report Unificato
        uses: actions/upload-artifact@v4
        with:
          # Un solo artifact con entrambi i risultati
          name: ecosystem-report-${{ github.run_number }}
          path: logs/ecosystem.log
          retention-days: 7

      - name: 5. Simple Ping to Supabase
        env:
          SB_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          # Facciamo una richiesta anonima. 
          # Risponderà probabilmente con un 401 (Unauthorized), 
          # ma è sufficiente per "svegliare" l'infrastruttura.
          curl -i $SB_URL > supabase_ping.txt

      - name: 5b. Upload Simple Ping Artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-ping
          path: supabase_ping.txt
          retention-days: 7

  # --- SECONDO JOB: DOPPIO INVIO (DIRETTO + ORCHESTRATORE) ---
  keep-alive-supabase:
    needs: ecosystem_check
    runs-on: ubuntu-latest
    steps:
      - name: 1. Send Heartbeat to Supabase (Legacy)
        env:
          SB_URL: ${{ secrets.SUPABASE_URL }}
          SB_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          curl -X POST "${SB_URL}/rest/v1/heartbeats" \
          -H "apikey: ${SB_KEY}" \
          -H "Authorization: Bearer ${SB_KEY}" \
          -H "Content-Type: application/json" \
          -d '{
            "vercel_status": "check_run", 
            "hf_status": "check_run",
            "notes": "Action #${{ github.run_number }} (Direct)"
          }'

      - name: 2. Wait for 10 seconds
        run: sleep 10

      - name: 3. Send Heartbeat to HF Orchestrator (New Path)
        env:
          HF_URL: "https://theridel-orchestratore.hf.space/webhook"
        run: |
          curl -X POST "$HF_URL" \
          -H "Content-Type: application/json" \
          -d '{
            "vercel_status": "check_run", 
            "hf_status": "check_run",
            "run_number": "${{ github.run_number }}",
            "notes": "Action #${{ github.run_number }} (via HF)",
            "source": "github_action"
          }'
